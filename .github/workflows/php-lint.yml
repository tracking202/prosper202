name: PHP Lint

on:
  push:
    paths:
      - '**.php'
  pull_request:
    paths:
      - '**.php'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
      - name: Run php -l
        id: php_lint
        continue-on-error: true
        run: |
          set +e
          ./scripts/php-lint.sh
          status=$?
          echo "exit_code=${status}" >> "$GITHUB_OUTPUT"
          if [ "${status}" -ne 0 ]; then
            echo "status=failed" >> "$GITHUB_OUTPUT"
            echo "::error::PHP lint reported syntax issues. Review logs above." >&2
          else
            echo "status=passed" >> "$GITHUB_OUTPUT"
          fi
          exit ${status}
      - name: Summarize lint results
        if: always()
        run: |
          status="${{ steps.php_lint.outputs.status }}"

          if [ "${status}" = "failed" ]; then
            result="❌ Failed"
            note="> Syntax issues were detected. Review the job log for file details."
          elif [ "${status}" = "passed" ]; then
            result="✅ Passed"
            note="> No syntax errors were detected."
          else
            result="⚠️ Unknown"
            note="> Lint status could not be determined."
          fi

          {
            echo "### PHP Lint Results"
            echo ""
            echo "| Check | Result |"
            echo "| --- | --- |"
            echo "| php -l | ${result} |"
            echo ""
            echo "${note}"
          } >> "$GITHUB_STEP_SUMMARY"
      - name: Fail when lint errors detected
        if: ${{ steps.php_lint.outputs.exit_code != '0' }}
        run: exit 1
